<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>스케줄 알림 설정</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f7f9fc;
      color: #333;
      margin: 0;
    }
    h1 {
      color: #1e88e5;
      margin-bottom: 20px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    input, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #1e88e5;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #1565c0; }
  </style>
</head>
<body>
  <h1>📅 알림 예약</h1>
  <div class="card">
    <textarea id="message" placeholder="보낼 메시지를 입력하세요"></textarea>
    <input type="date" id="date">
    <input type="time" id="time">
    <button id="subscribe">🔔 알림 허용</button>
    <button id="schedule">✅ 예약 등록</button>
  </div>

  <script>
    const SERVER_URL = "https://push-notification-server.onrender.com"; // Render URL로 교체

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }

    let subscription = null;

    document.getElementById('subscribe').addEventListener('click', async () => {
      const registration = await navigator.serviceWorker.ready;
      const existingSub = await registration.pushManager.getSubscription();
      if (existingSub) {
        subscription = existingSub;
      } else {
        const response = await fetch(`${SERVER_URL}/public-key`);
        const publicKey = await response.text();
        subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey),
        });
      }
      await fetch(`${SERVER_URL}/subscribe`, {
        method: 'POST',
        body: JSON.stringify(subscription),
        headers: { 'Content-Type': 'application/json' }
      });
      alert('✅ 알림이 활성화되었습니다!');
    });

    document.getElementById('schedule').addEventListener('click', async () => {
      const message = document.getElementById('message').value.trim();
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;

      if (!message || !date || !time) return alert("모든 항목을 입력해주세요.");

      const timestamp = new Date(`${date}T${time}:00`).getTime();
      await fetch(`${SERVER_URL}/schedule`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, timestamp })
      });
      alert('✅ 알림이 예약되었습니다!');
    });

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }
  </script>
</body>
</html>
