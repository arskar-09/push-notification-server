<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>예약 알림</title>
</head>
<body>
  <h1>예약 알림</h1>

  <label>메시지: <input type="text" id="message"></label><br>
  <label>날짜/시간: <input type="datetime-local" id="datetime"></label><br>
  <button id="subscribeBtn">구독하기</button>
  <button id="scheduleBtn">예약 알림</button>

  <script>
    const SERVER_URL = 'http://localhost:3000'; // Node.js 서버 주소
    const PUBLIC_VAPID_KEY = 'BJI70reaMqaOyL0aXjZW-3KSfgeJA2IbACMi1SgT_36V5OXWVjlZYV32wVQuioXblmTtNqR99udAv-G_muJQiqY';

    // 서비스워커 등록
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('SW registered', reg))
        .catch(err => console.error('SW registration failed', err));
    }

    // VAPID 키 변환
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    // 푸시 구독
    async function subscribeUser() {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY)
      });

      await fetch(`${SERVER_URL}/subscribe`, {
        method: 'POST',
        body: JSON.stringify(subscription),
        headers: { 'Content-Type': 'application/json' }
      });

      alert('구독 완료!');
    }

    document.getElementById('subscribeBtn').addEventListener('click', subscribeUser);

    // 예약 알림 전송
    document.getElementById('scheduleBtn').addEventListener('click', async () => {
      const message = document.getElementById('message').value;
      const datetime = document.getElementById('datetime').value;
      if (!message || !datetime) return alert('메시지와 시간을 입력해주세요.');

      const timestamp = new Date(datetime).getTime();

      await fetch(`${SERVER_URL}/schedule`, {
        method: 'POST',
        body: JSON.stringify({ message, timestamp }),
        headers: { 'Content-Type': 'application/json' }
      });

      alert('알림 예약 완료!');
    });
  </script>
</body>
</html>
