<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TimePeek 예약 알림</title>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background:#f8fafc; color:#111; padding:24px; max-width:480px; margin:auto; }
    h1 { text-align:center; margin-bottom:20px; color:#2563eb; }
    .card { background:white; padding:20px; border-radius:14px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    label { display:block; margin-top:10px; font-weight:600; }
    input, textarea { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px; margin-top:6px; font-size:15px; }
    button { width:100%; margin-top:14px; padding:12px; border:none; border-radius:10px; background:#2563eb; color:white; font-size:16px; font-weight:600; cursor:pointer; }
    button:hover { background:#1e40af; }
    p.status { text-align:center; color:#64748b; margin-top:10px; font-size:14px; }
  </style>
</head>
<body>
  <h1>TimePeek 알림 예약</h1>
  <div class="card">
    <label>알림 내용</label>
    <textarea id="message" rows="3" placeholder="예: 내일 오전 9시에 회의 준비"></textarea>

    <label>날짜</label>
    <input type="date" id="dateInput">

    <label>시간</label>
    <input type="time" id="timeInput">

    <button id="subscribeBtn">알림 구독</button>
    <button id="scheduleBtn">알림 예약</button>

    <p class="status" id="status"></p>
  </div>

<script>
const SERVER_URL = 'https://my-push-server.onrender.com';
const PUBLIC_VAPID_KEY = 'BJI70reaMqaOyL0aXjZW-3KSfgeJA2IbACMi1SgT_36V5OXWVjlZYV32wVQuioXblmTtNqR99udAv-G_muJQiqY';

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
}

async function registerSW() {
  const reg = await navigator.serviceWorker.register('service-worker.js');
  return reg;
}

async function subscribeUser() {
  const reg = await registerSW();
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    alert('알림 권한을 허용해야 알림을 받을 수 있습니다.');
    return;
  }
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY)
  });
  await fetch(`${SERVER_URL}/subscribe`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(sub)
  });
  document.getElementById('status').textContent = '✅ 알림 구독 완료';
}

document.getElementById('subscribeBtn').addEventListener('click', subscribeUser);

function getTimestamp() {
  const date = document.getElementById('dateInput').value;
  const time = document.getElementById('timeInput').value;
  if (!date || !time) return null;
  return new Date(`${date}T${time}`).getTime();
}

document.getElementById('scheduleBtn').addEventListener('click', async () => {
  const message = document.getElementById('message').value.trim();
  const timestamp = getTimestamp();
  if (!message || !timestamp) return alert('메시지와 날짜/시간을 모두 입력하세요.');
  if (timestamp <= Date.now()) return alert('미래 시간을 선택하세요.');

  await fetch(`${SERVER_URL}/schedule`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message, timestamp })
  });

  document.getElementById('status').textContent = '⏰ 예약 완료! 지정된 시간에 알림이 전송됩니다.';
  alert('예약이 등록되었습니다.');
});

// 오늘 날짜 기본 설정
(function initDefaults(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
  const hh = String(today.getHours()).padStart(2,'0');
  const mi = String(today.getMinutes()+5).padStart(2,'0');
  document.getElementById('timeInput').value = `${hh}:${mi}`;
})();
</script>
</body>
</html>
